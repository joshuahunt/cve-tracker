#!/bin/bash
#set -x

# Source global config info
source config

DATE="$(date +%d%m%Y)"

# TODO: Add lock file so we can only run one instance of this at a time.
#	If we do have two instances then the db files can get corrupted
#	very easily.

# Basic db check and just look at the # of fields like so:
#awk '{ if (NF != 8) print $0 }' cve.db

pushd $SCRIPTS_PATH

# First thing, sync to the latest version of everything

# TODO: Catch errors in syncing
# Sync to latest $UBUNTU_TRACKER
# For initial checkout use:
# bzr branch lp:ubuntu-cve-tracker ~/projects/ubuntu-cve-tracker/
pushd $UBUNTU_TRACKER
bzr merge
bzr commit -m "Merge $DATE from main branch"
popd

# Sync stable kernel
pushd $STABLE_KERNEL
git checkout master
git pull
popd

if [ ! -e "$CVE_DB" ]; then
	echo
	echo "No CVE DB Found!"
	echo
	while :; do
		read -p "Would you like to create a new CVE DB file?" yn
		case $yn in
			[Yy]* ) touch $CVE_DB; break;;
			[Nn]* ) exit 1;;
			* ) echo "Please enter yes or no.";;
		esac
	done
fi

mv $CVE_DB ${CVE_DB}.old

time (
	$SCRIPTS_PATH/get-cves.sh > $CVE_DB
)

# Append CVE override info to cve.list
cat $DB_PATH/override >> $CVE_DB

time (
	sort -o $CVE_DB -k2,3 $CVE_DB
)

popd
time (
	$SCRIPTS_PATH/xref-cve.sh
)

popd

# Commit any new mails, updated db, or updated html reports
# I don't want to commit things which are not part of the nightly
# run which may have been left in an uncommitted state from something
# else
git add $MAIL_PATH/*.msg
git add $HTML_PATH/*.html
git add $DB_PATH/*
git commit -m "Nightly automated update - $DATE"
