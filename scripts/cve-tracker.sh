#!/bin/bash
#set -x

# Source global config info
source config

DATE="$(date +%d%m%Y)"

# TODO: Add lock file so we can only run one instance of this at a time.
#	If we do have two instances then the db files can get corrupted
#	very easily.

# Basic db check and just look at the # of fields like so:
#awk '{ if (NF != 8) print $0 }' cve.db

pushd $SCRIPTS_PATH

# First thing, sync to the latest version of everything

# TODO: Catch errors in syncing
# Sync to latest $UBUNTU_TRACKER
# For initial checkout use:
# bzr branch lp:ubuntu-cve-tracker ~/projects/ubuntu-cve-tracker/
pushd $UBUNTU_TRACKER
bzr merge
bzr commit -m "Merge $DATE from main branch"
popd

# Sync stable kernel
pushd $STABLE_KERNEL
git checkout master
git pull
popd

if [ ! -e "$CVE_DB" ]; then
	echo "No CVE DB Found!"
	# TODO: Make this ask if we should create a new one
	exit 1
fi

cp $CVE_DB ${CVE_DB}.old

time (
	$SCRIPTS_PATH/get-cves.sh > $DB_PATH/cve.list
)

time (
	sort -k2,3 $DB_PATH/cve.list > $CVE_DB
)

popd
time (
	$SCRIPTS_PATH/xref-cve.sh
)

popd

# Commit any new mails, updated db, or updated html reports
# I don't want to commit things which are not part of the nightly
# run which may have been left in an uncommitted state from something
# else
git add $MAIL_PATH/*.msg
git add $HTML_PATH/*.html
git add $DB_PATH/*
git commit -m "Nightly automated update - $DATE"
