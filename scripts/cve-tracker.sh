#!/bin/bash
#set -x

CVE_TRACKER="/home/johunt/projects/cve-tracker"
UBUNTU_TRACKER="/home/johunt/projects/ubuntu-cve-tracker"
STABLE_KERNEL="/home/johunt/projects/linux-stable"
LINUX_KERNEL="/home/johunt/projects/linux-2.6"

CVE_DB=$CVE_TRACKER/cve.db

DATE="$(date +%d%m%Y)"

# Basic db check and just look at the # of fields like so:
#awk '{ if (NF != 8) print $0 }' cve.db

# First thing, sync to the latest version of everything

# TODO: Catch errors in syncing
# Sync to latest $UBUNTU_TRACKER
pushd $UBUNTU_TRACKER
bzr merge
bzr commit -m "Merge $DATE from main branch"
popd

# Sync stable kernel
pushd $STABLE_KERNEL
git checkout master
git pull
popd

pushd $UBUNTU_TRACKER
cp $CVE_TRACKER/scripts/get-cves.sh $UBUNTU_TRACKER

if [ ! -e "$CVE_DB" ]; then
	echo "No CVE DB Found!"
	# TODO: Make this ask if we should create a new one
	exit 1
fi

cp $CVE_DB ${CVE_DB}.old

time (
	for x in active retired
	do
		pushd $x > /dev/null
		../get-cves.sh $CVE_DB
		popd > /dev/null
	done > $CVE_TRACKER/cve.list
)

time (
sort -k2 $CVE_TRACKER/cve.list > $CVE_DB
)

popd
pushd $STABLE_KERNEL
cp $CVE_TRACKER/scripts/xref-cve.sh $STABLE_KERNEL
time ./xref-cve.sh $CVE_DB

popd

# TODO: All files (db and otherwise) should be stored in the run directory
# TODO: We should be checking the results into git here...
