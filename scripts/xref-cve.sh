#!/bin/bash

input_file=$1

cve_url="http://web.nvd.nist.gov/view/vuln/detail?vulnId="
linus_url="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id="
stable_url_1="https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?h="
stable_url_2="&id="

echo_err() {
	echo "$@" 1>&2
}

# Version compare
# Returns:
#	0: if both are equal
#	1: if ver1 > ver2
#	-1: if ver2 > ver1
cmp_ver() {
	local ver1=$1
	local ver2=$2
	local retval=0

	echo_err "comparing $ver1 to $ver2"
	if [ "$ver1" == "$ver2" ]; then
		echo 0
		return
	fi
	
	local result=$(echo -e "$ver1\n$ver2" | sort -V | awk 'NR > 1 { exit }; 1')

	if [ "$result" == "$ver1" ]; then
		retval="-1"
	elif [ "$result" == "$ver2" ]; then
		retval="1"
	fi

	echo $retval

	echo_err $retval
}

get_commit_date() {
	local commit=$1

	pushd /home/johunt/projects/linux-2.6 > /dev/null
	git log -1 $commit --date=short --pretty=format:%cd
	popd > /dev/null
}

for branch in origin/linux-3.0.y origin/linux-3.4.y origin/linux-3.10.y
do
	filename=$(echo $branch | sed 's/origin\///')
	branch_ver=$(echo $filename | sed -e 's/linux-//' -e 's/\.y//') 

	echo '<html>' > $filename-stable-cve-list.html
	{
		echo '<head><link rel="stylesheet" href="css/blue/style.css" type="text/css"></head>'
		echo '<table id="myTable" class="tableSorter" border="0" cellpadding="0" cellspacing="1">'
		echo '<body>'
		echo '<thead>'
		echo '<tr>'
		echo '<th>Public Date</th>'
		echo '<th>CVE</th>'
		echo '<th>Commit Date</th>'
		echo '<th>Linus Tag</th>'
		echo '<th>Linus Fix</th>'
		echo "<th>$filename Stable Fix</th>"
		echo '</tr>'
		echo '</thead>'
		echo '<tbody>'
		# Input file format
		while read public_date cve break break_tag fix fix_tag 
		do
			if [ "$(cmp_ver $fix_tag $branch_ver)" -eq "1" ]; then 
				echo '<tr>'
				echo "<td>$public_date</td>"
				echo "<td><a href=${cve_url}${cve}>$cve</a></td>"
				echo "<td>$(get_commit_date $fix)</td>"
				echo "<td>$fix_tag</td>"
				echo "<td><a href=${linus_url}${fix}>$fix</a></td>"
				result=$(git --no-pager log $branch --grep="commit $fix" --pretty=format:%H)
				echo "<td><a href=${stable_url_1}${filename}${stable_url_2}${result}>$result</a></td>"
				echo '</tr>'
			fi
		done < $input_file
		echo '</tbody>'
		echo '</table>'
		echo '<script type="text/javascript" src="js/jquery-latest.js"></script>'
		echo '<script type="text/javascript" src="js/jquery.tablesorter.js"></script>'
		echo '<script type="text/javascript">'
		echo '$(document).ready(function() {'
		echo '	$("#myTable").tablesorter({sortList: [[2,1]]});'
		echo '});'
		echo '</script>'
		echo '<body>'
		echo '</html>'
	} >> $filename-stable-cve-list.html
done
