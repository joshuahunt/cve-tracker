#!/bin/bash
#set -x

get_tag() {
	local commit=$1

	pushd /home/johunt/projects/linux-stable > /dev/null

	if [ "$commit" != "-" ]; then
		git describe $commit | awk -F- '{ print $1 }' | sed 's/^v\([2-9]\+\)\.\([0-9]\{1,2\}\)\(\.[0-9]\{1,2\}\)\?/\1\.\2/'
	else
		echo $commit
	fi

	popd > /dev/null
}

ORIG_IFS="$IFS"
for x in CVE-2013*
do
	grep -q Patches_linux $x
	if [ "$?" -eq "0" ]; then
		date="$(grep PublicDate: $x | awk '{ print $2 }')"
		#grep break-fix $x | awk '{ printf "'$date' '$x' %s\n", $NF }'
		#break="$(grep break-fix $x | awk '{ print $3 }')"
		#fix="$(grep break-fix $x | awk '{ print $NF }')"

		breakfix="$(grep break-fix $x | awk '{ printf "%s,%s ", $(NF-1),$NF }')"

		for y in $breakfix
		do
			IFS=","
			set -- $y
			break="$1"
			fix="$2"
			IFS="$ORIG_IFS"

			if [ "$break" != "-" ]; then
				break_tag="$(get_tag $break)"
			else
				break_tag="-"
			fi

			if [ "$(echo $fix | grep -c local)" -ne "0" ]; then
				fix_tag="-"
			else
				fix_tag="$(get_tag $fix)"
			fi

			echo "$date $x $break $break_tag $fix $fix_tag"
		done
	fi
done
