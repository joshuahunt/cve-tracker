#!/bin/bash
#set -x
get_commit_date() {
        local commit=$1

        pushd /home/johunt/projects/linux-2.6 > /dev/null
        git log -1 $commit --date=short --pretty=format:%cd
        popd > /dev/null
}

get_tag() {
	local commit=$1

	pushd /home/johunt/projects/linux-stable > /dev/null

	if [ "$commit" != "-" ]; then
		git describe $commit | awk -F- '{ print $1 }' | sed 's/^v\([2-9]\+\)\.\([0-9]\{1,2\}\)\(\.[0-9]\{1,2\}\)\?/\1\.\2/'
	else
		echo $commit
	fi

	popd > /dev/null
}

ORIG_IFS="$IFS"
for x in CVE-2013*
do
	grep -q Patches_linux $x
	if [ "$?" -eq "0" ]; then
		date="$(grep PublicDate: $x | awk '{ print $2 }')"

		breakfix="$(grep break-fix $x | awk '{ printf "%s,%s ", $(NF-1),$NF }')"

		for y in $breakfix
		do
			IFS=","
			set -- $y
			break="$1"
			fix="$2"
			IFS="$ORIG_IFS"

			if [ "$break" != "-" ]; then
				break_tag="$(get_tag $break)"
				break_date="$(get_commit_date $break)"
			else
				break_tag="-"
				break_date="-"
			fi

			if [ "$(echo $fix | grep -c local)" -eq "0" ]; then
				fix_tag="$(get_tag $fix)"
				fix_date="$(get_commit_date $fix)"
			else
				fix_tag="-"
				fix_date="-"
			fi

			# Output file format
			# public_date cve break_date break break_tag fix_date fix fix_tag 
			echo "$date $x $break_date $break $break_tag $fix_date $fix $fix_tag"
		done
	fi
done
