#!/bin/bash
#set -x

CVE_DB="$1"

get_commit_date() {
        local commit=$1
	local commit_ver=$2
	local ret=""

        pushd /home/johunt/projects/linux-stable > /dev/null
        #git log -1 $commit v${commit_ver} --date=short --pretty=format:%cd
        ret="$(git log -n 1 $commit --date=short --pretty=format:%cd)"
	if [ -n "$ret" ]; then
		echo $ret
	else
		echo "-"
	fi
        popd > /dev/null
}

get_tag() {
	local commit=$1
	local cve=$2
	local pos=$3
	local ret=""
	local cached

	# TODO: A little skeptical of this right now, but it speeds it up so much it's worth going down this path
	cached=$(grep -m1 $cve ${CVE_DB}.old | grep $commit | awk '{ print $'$pos' }')
	if [ -n "$cached" ]; then
		echo "$cached"
		return
	fi

	pushd /home/johunt/projects/linux-stable > /dev/null

	if [ "$commit" != "-" ]; then
		ret="$(git describe --contains $commit | awk -F- '{ print $1 }' | sed 's/^v\([2-9]\+\)\.\([0-9]\{1,2\}\)\(\.[0-9]\{1,2\}\)\?.*/\1\.\2/')"
	else
		echo "$commit"
	fi

	if [ -n "$ret" ]; then
		echo $ret
	else
		echo "-"
	fi

	popd > /dev/null
}

ORIG_IFS="$IFS"
for x in CVE-201[2-9]*
do
	grep -q Patches_linux $x
	if [ "$?" -eq "0" ]; then
		date="$(grep PublicDate: $x | awk '{ print $2 }')"
		#grep break-fix $x | awk '{ printf "'$date' '$x' %s\n", $NF }'
		#break="$(grep break-fix $x | awk '{ print $3 }')"
		#fix="$(grep break-fix $x | awk '{ print $NF }')"

		breakfix="$(egrep '^[[:space:]]*break-fix' $x | awk '{ printf "%s,%s ", $(NF-1),$NF }')"

		for y in $breakfix
		do
			IFS=","
			set -- $y
			break="$1"
			fix="$2"
			IFS="$ORIG_IFS"

			if [ "$break" != "-" ]; then
				break_tag="$(get_tag $break $x 5)"
				break_date="$(get_commit_date $break $break_tag)"
			else
				break_tag="-"
				break_date="-"
			fi

			if [ "$(echo $fix | grep -c local)" -eq "0" ]; then
				fix_tag="$(get_tag $fix $x 8)"
				fix_date="$(get_commit_date $fix $fix_tag)"
			else
				fix_tag="-"
				fix_date="-"
			fi

			# Output file format
			# public_date cve break_date break break_tag fix_date fix fix_tag 
			echo "$date $x $break_date $break $break_tag $fix_date $fix $fix_tag"
		done
	fi
done
