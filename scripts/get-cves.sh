#!/bin/bash
set -x

source config

valid_hash() {
	local commit=$1

	# Skip if the commit is '-' since we can't look that up AND
	# Ubuntu sometimes pushes local changes (those which they do not push upstream) and the fix tag will contain 'local*' so skip those and return "-" AND
	# it's a valid hex value 
	if [[ "$commit" != "-" && "$commit" != *"local"* && "$commit" =~ ^[[:xdigit:]]+$ ]]; then
		return 0
	else
		return 1
	fi
}

get_commit_date() {
        local commit=$1
	local commit_ver=$2
	local ret="-"

        pushd $STABLE_KERNEL > /dev/null
	if valid_hash $commit; then
		ret="$(git log -n 1 $commit --date=short --pretty=format:%cd)"
		if [ $? -ne 0 ]; then
			ret="-"
		fi
	fi
	echo $ret
        popd > /dev/null
}

get_tag() {
	local commit=$1
	local cve=$2
	local pos=$3
	local ret="-"
	local cached

	# TODO: A little skeptical of this right now, but it speeds it up so much it's worth going down this path
	cached=$(grep -m1 $cve ${CVE_DB}.old | grep $commit | awk '{ print $'$pos' }')
	if [[ -n "$cached" && "$cached" != "-" ]]; then
		echo "$cached"
		return
	fi

	pushd $STABLE_KERNEL > /dev/null

	if valid_hash $commit; then
		# Get the Major . Minor kernel version this commit went into
		ret="$(git describe --contains $commit | awk -F- '{ print $1 }' | sed 's/^v\([2-9]\+\)\.\([0-9]\{1,2\}\)\(\.[0-9]\{1,2\}\)\?.*/\1\.\2/')"
		if [[ $? -ne 0 || -z "$ret" || ! "$ret" =~ ^[0-9]+\.[0-9]+$ ]]; then
			ret="-"
		fi
	fi

	echo $ret

	popd > /dev/null
}

get_cves() {
	ORIG_IFS="$IFS"
	shopt -s nullglob
	for x in CVE-201[3-9]* CVE-202*-*
	do
		# Skip CVE if it's present in the override file
		if [ "$(grep -c $x $DB_PATH/override)" -ne "0" ]; then
			continue
		fi

		# Format in CVE files is usually
		# 
		# Patches_linux:
		# break-fix: - ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5

		# First question, does this CVE touch Linux?
		if grep -q Patches_linux: $x; then

			date="$(grep PublicDate: $x | awk '{ print $2 }')"

			# Example break/fix info in CVE file (where break is commit which caused the breakage):
			# Unknown break or fix are filled in with '-'
			# break-fix: - ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5
			breakfix="$(egrep -i '^[[:space:]]*break-fix' $x | awk '{ printf "%s,%s ", $(NF-1),$NF }')"

			for y in $breakfix
			do
				IFS=","
				set -- $y
				break="$1"
				fix="$2"
				IFS="$ORIG_IFS"

				if [ "$break" != "-" ]; then
					break_tag="$(get_tag $break $x 5)"
					break_date="$(get_commit_date $break $break_tag)"
				else
					break_tag="-"
					break_date="-"
				fi

				if [ "$fix" != "-" ]; then
					fix_tag="$(get_tag $fix $x 8)"
					fix_date="$(get_commit_date $fix $fix_tag)"
				else
					fix_tag="-"
					fix_date="-"
				fi

				# Output file format
				# public_date cve break_date break break_tag fix_date fix fix_tag 
				echo "$date $x $break_date $break $break_tag $fix_date $fix $fix_tag"
			done
		fi
	done
	shopt -u nullglob
}

for x in active retired
do
	pushd $UBUNTU_TRACKER/$x > /dev/null
       	get_cves
       	popd > /dev/null
done

