#!/bin/bash
#set -x

# New Line
line1="2013-09-30 CVE-2013-4387 2005-10-28 e89e9cf539a28df7d0eb1d0a545368e9920b34ac 2.6 2013-09-24 2811ebac2521ceac84f2bdae402455baa6a7fb47 3.12 2013-10-13 f5a30bc1d6b338ecba5b948798a48bc5b59ef30f 3.10.16"

# Old line with break missing
line2="2013-09-30 CVE-2013-4387 - - - 2013-09-24 2811ebac2521ceac84f2bdae402455baa6a7fb47 3.12 2013-10-13 f5a30bc1d6b338ecba5b948798a48bc5b59ef30f 3.10.16"

# Old line with stable tag missing
line3="2013-09-30 CVE-2013-4387 2005-10-28 e89e9cf539a28df7d0eb1d0a545368e9920b34ac 2.6 2013-09-24 2811ebac2521ceac84f2bdae402455baa6a7fb47 3.12 - - -"

# Old line with stable tag missing
line4="2013-09-30 CVE-2013-4387 - - - 2013-09-24 2811ebac2521ceac84f2bdae402455baa6a7fb47 3.12 - - -"

# Changed public date
line5="2013-10-15 CVE-2013-4387 2005-10-28 e89e9cf539a28df7d0eb1d0a545368e9920b34ac 2.6 2013-09-24 2811ebac2521ceac84f2bdae402455baa6a7fb47 3.12 2013-10-13 f5a30bc1d6b338ecba5b948798a48bc5b59ef30f 3.10.16"

fields=([1]="Public Date" "CVE" "Break Date" "Break Commit" "Break Tag" "Linus Fix Date" "Linus Commit" "Linus Tag" "Stable Date" "Stable Commit" "Stable Tag")

function get_index() {
	local value="$1"

	for i in "${!fields[@]}"
	do
		if [ "${fields[$i]}" == "$value" ]; then
			echo $i
			break
		fi
	done
}

function find_diff_records() {


	local old="$1"
	local new="$2"
	local nr_fields=${#fields[@]}
	declare -A old_field
	declare -A new_field

	local fields_changed=""

	echo "$old"
	echo "$new"

	for y in $(seq 1 $nr_fields)
	do
		old_field[$y]=$(echo $old | awk '{ print $'$y' }')
                if [ -z "$old_field" ]; then
                        old_field="*"
                fi
		new_field[$y]=$(echo $new | awk '{ print $'$y' }')

		if [ "${old_field[$y]}" != "${new_field[$y]}" ]; then
			#echo "${fields[$y]} differs old: ${old_field[$y]} -> new: ${new_field[$y]}"
			if [ -z "$fields_changed" ]; then
				fields_changed="${fields[$y]}"
			else
				fields_changed="$fields_changed,${fields[$y]}"
			fi
		fi
	done
	if [ "$(echo $fields_changed | awk -F, '{ print NF }')" -eq "$nr_fields" ]; then
                echo "This is a new CVE"        
        fi
	echo "The following fields have changed: $fields_changed"
	ORIGIFS=$IFS
	IFS=,
	for i in $fields_changed
	do
		index=$(get_index $i)
		echo "${fields[$index]}: ${old_field[$index]} -> ${new_field[$index]}"
	done
	IFS=$ORIGIFS
	echo
}

find_diff_records "$line2" "$line1"
find_diff_records "$line3" "$line1"
find_diff_records "$line4" "$line1"
find_diff_records "$line5" "$line1"
find_diff_records "" "$line1"
